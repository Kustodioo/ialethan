"use strict";(()=>{var e={};e.id=773,e.ids=[773],e.modules={1738:e=>{e.exports=require("multer")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},55:e=>{e.exports=require("whatsapp-web.js")},2630:e=>{e.exports=import("libphonenumber-js")},7147:e=>{e.exports=require("fs")},1017:e=>{e.exports=require("path")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},2274:(e,t,a)=>{a.a(e,async(e,s)=>{try{a.r(t),a.d(t,{config:()=>d,default:()=>c,routeModule:()=>u});var n=a(1802),i=a(7153),o=a(6249),r=a(2731),l=e([r]);r=(l.then?(await l)():l)[0];let c=(0,o.l)(r,"default"),d=(0,o.l)(r,"config"),u=new n.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/enviar-mensagem",pathname:"/api/enviar-mensagem",bundlePath:"",filename:""},userland:r});s()}catch(e){s(e)}})},2731:(e,t,a)=>{a.a(e,async(e,s)=>{try{a.r(t),a.d(t,{config:()=>f,default:()=>m});var n=a(1738),i=a.n(n),o=a(2630),r=a(55),l=a(7147),c=a.n(l),d=a(1017),u=a.n(d),p=a(174),h=e([o]);o=(h.then?(await h)():h)[0];let g=i()({dest:"/tmp"}),f={api:{bodyParser:!1}};async function m(e,t){"POST"===e.method?g.single("imagem")(e,t,async a=>{let s;if(a)return t.status(500).json({error:"Erro ao processar o upload do arquivo"});try{await p.Z.waitForReady()}catch(e){return console.error("Erro ao esperar pelo cliente WhatsApp:",e),t.status(500).json({error:"Cliente WhatsApp n\xe3o est\xe1 pronto"})}let{clientesSelecionados:n,mensagem:i}=e.body;if(console.log("Dados recebidos:"),console.log("Clientes selecionados:",n),console.log("Mensagem:",i),console.log("Arquivo:",e.file),!n||!i)return t.status(400).json({error:"Faltam dados para o envio da mensagem"});let l=JSON.parse(n);if(e.file){let t=c().readFileSync(e.file.path).toString("base64");s=new r.MessageMedia("image/png",t,u().basename(e.file.originalname))}for(let e of l)try{let t=(0,o.parsePhoneNumber)(e.numero,"BR");if(!t||!t.isValid())throw Error(`N\xfamero de telefone inv\xe1lido: ${e.numero}`);let a=t.format("E.164").slice(1),n=i.replace("{link}",e.link);s?await p.Z.sendMessage(`${a}@c.us`,s,{caption:n}):await p.Z.sendMessage(`${a}@c.us`,n),console.log(`Mensagem enviada para ${e.nome} (${a})`)}catch(t){console.error(`Erro ao enviar mensagem para ${e.nome}:`,t)}e.file&&c().unlinkSync(e.file.path),t.status(200).json({message:"Mensagens enviadas com sucesso"})}):(t.setHeader("Allow",["POST"]),t.status(405).end(`Method ${e.method} Not Allowed`))}s()}catch(e){s(e)}})},174:(e,t,a)=>{a.d(t,{Z:()=>u});var s=a(55);let n=require("qrcode-terminal");var i=a.n(n),o=a(1017),r=a.n(o);let l=require("fs-extra");var c=a.n(l);class d{constructor(){this.isReady=!1,this.sessionPath=r().join(process.cwd(),".wwebjs_auth"),this.client=new s.Client({authStrategy:new s.LocalAuth({dataPath:this.sessionPath,clientId:"client-one"}),puppeteer:{headless:!0,args:["--no-sandbox","--disable-setuid-sandbox"]}}),this.client.on("qr",e=>{i().generate(e,{small:!0}),console.log("QR RECEIVED. Scan it with your WhatsApp app.")}),this.client.on("ready",()=>{console.log("WhatsApp client is ready!"),this.isReady=!0}),this.client.on("disconnected",async e=>{console.log("WhatsApp client was disconnected",e),this.isReady=!1,await this.cleanSession(),this.initialize()}),this.initialize()}static getInstance(){return d.instance||(d.instance=new d),d.instance}async initialize(){try{await this.client.initialize()}catch(e){console.error("Failed to initialize WhatsApp client:",e),await this.cleanSession(),setTimeout(()=>this.initialize(),5e3)}}async cleanSession(){try{await c().remove(this.sessionPath),console.log("Session cleaned successfully")}catch(e){console.error("Failed to clean session:",e)}}async sendMessage(e,t,a){if(!this.isReady)throw Error("WhatsApp client is not ready");return await this.client.sendMessage(e,t,a)}async waitForReady(){if(!this.isReady)return new Promise(e=>{let t=setInterval(()=>{this.isReady&&(clearInterval(t),e())},1e3)})}}let u=d.getInstance()},7153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,t,a)=>{e.exports=a(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var a=t(t.s=2274);module.exports=a})();